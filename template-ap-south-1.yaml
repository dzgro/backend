AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Auto-generated SAM template with layers
Resources:
  RazorpayWebhookDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: RazorpayWebhookDLQ
      RedriveAllowPolicy:
        redrivePermission: allowAll
  RazorpayWebhook:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: RazorpayWebhook
      RedriveAllowPolicy:
        redrivePermission: allowAll
      VisibilityTimeout: 900
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt RazorpayWebhookDLQ.Arn
        maxReceiveCount: 1
  RazorpayWebhookToRazorpayWebhookEvent:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !GetAtt RazorpayWebhook.Arn
      FunctionName: !Ref RazorpayWebhookFunction
      Enabled: true
      BatchSize: 1
  AmazonReportsDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: AmazonReportsDLQ
      RedriveAllowPolicy:
        redrivePermission: allowAll
  AmazonReports:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: AmazonReports
      RedriveAllowPolicy:
        redrivePermission: allowAll
      VisibilityTimeout: 900
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AmazonReportsDLQ.Arn
        maxReceiveCount: 1
  AmazonReportsToAmazonDailyReportEvent:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !GetAtt AmazonReports.Arn
      FunctionName: !Ref AmazonDailyReportFunction
      Enabled: true
      BatchSize: 1
  PaymentDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: PaymentDLQ
      RedriveAllowPolicy:
        redrivePermission: allowAll
  Payment:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: Payment
      RedriveAllowPolicy:
        redrivePermission: allowAll
      VisibilityTimeout: 900
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt PaymentDLQ.Arn
        maxReceiveCount: 1
  PaymentToPaymentProcessorEvent:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      EventSourceArn: !GetAtt Payment.Arn
      FunctionName: !Ref PaymentProcessorFunction
      Enabled: true
      BatchSize: 1
  DzgroReportsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: dzgro-reports
  DzgroBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: dzgro
  DzgroInvoicesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: dzgro-invoices
  DzgroCloudfrontBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: dzgro-cloudfront
  AmazonDailyReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AmazonDailyReport
      CodeUri: functions\amazon_daily_report\src
      Handler: amazon_daily_report.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref amazonapiLayer
      - !Ref dateutilLayer
      - !Ref dzgrosecretsLayer
      - !Ref sqsLayer
      - !Ref storageLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  DzgroReportsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: DzgroReports
      CodeUri: functions\dzgro_reports\src
      Handler: dzgro_reports.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      - !Ref feddbLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  DzgroReportsS3TriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: DzgroReportsS3Trigger
      CodeUri: functions\dzgro_reports_s3_trigger\src
      Handler: dzgro_reports_s3_trigger.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      - !Ref storageLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  AmsChangeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AmsChange
      CodeUri: functions\ams_change\src
      Handler: ams_change.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  AmsPerformanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AmsPerformance
      CodeUri: functions\ams_performance\src
      Handler: ams_performance.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  PaymentProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: PaymentProcessor
      CodeUri: functions\payment_processor\src
      Handler: payment_processor.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dateutilLayer
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      - !Ref storageLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  RazorpayWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: RazorpayWebhook
      CodeUri: functions\razorpay_webhook\src
      Handler: razorpay_webhook.handler.handler
      Runtime: python3.12
      Timeout: 900
      Layers:
      - !Ref dbLayer
      - !Ref dzgrosecretsLayer
      Role: arn:aws:iam::522814698847:role/Lambda_Execution
      Architectures:
      - x86_64
  amazonapiLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: amazonapi
      ContentUri: D:\github\sam-app\.layers\amazonapi.zip
      CompatibleRuntimes:
      - python3.12
  dateutilLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: date_util
      ContentUri: D:\github\sam-app\.layers\date_util.zip
      CompatibleRuntimes:
      - python3.12
  dbLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: db
      ContentUri: D:\github\sam-app\.layers\db.zip
      CompatibleRuntimes:
      - python3.12
  dzgrosecretsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: dzgrosecrets
      ContentUri: D:\github\sam-app\.layers\dzgrosecrets.zip
      CompatibleRuntimes:
      - python3.12
  feddbLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: fed_db
      ContentUri: D:\github\sam-app\.layers\fed_db.zip
      CompatibleRuntimes:
      - python3.12
  sqsLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: sqs
      ContentUri: D:\github\sam-app\.layers\sqs.zip
      CompatibleRuntimes:
      - python3.12
  storageLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: storage
      ContentUri: D:\github\sam-app\.layers\storage.zip
      CompatibleRuntimes:
      - python3.12
